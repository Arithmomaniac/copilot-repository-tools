<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ session.workspace_name or session.session_id }} - {{ title }}</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
:root {
    --bg-primary: #ffffff;
    --bg-secondary: #f6f8fa;
    --bg-tertiary: #f0f0f0;
    --text-primary: #24292f;
    --text-secondary: #57606a;
    --border-color: #d0d7de;
    --link-color: #0969da;
    --user-bg: #ddf4ff;
    --assistant-bg: #ffffff;
    --code-bg: #f6f8fa;
    --mark-bg: #fff8c5;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-tertiary: #21262d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
        --border-color: #30363d;
        --link-color: #58a6ff;
        --user-bg: #1f3d5c;
        --assistant-bg: #161b22;
        --code-bg: #161b22;
        --mark-bg: #3d3d00;
    }
}

* {
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background-color: var(--bg-primary);
    margin: 0;
    padding: 0;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    padding: 20px 0;
    margin-bottom: 20px;
    position: sticky;
    top: 0;
    z-index: 100;
}

header h1 {
    margin: 0;
}

.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: var(--link-color);
    text-decoration: none;
}

.back-link:hover {
    text-decoration: underline;
}

.session-meta {
    color: var(--text-secondary);
    font-size: 0.85em;
    margin-top: 8px;
}

.session-meta span {
    margin-right: 16px;
}

.edition-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: 500;
}

.edition-badge.stable {
    background-color: #dafbe1;
    color: #1a7f37;
}

.edition-badge.insider {
    background-color: #ddf4ff;
    color: #0969da;
}

.edition-badge.cli {
    background-color: #fff8c5;
    color: #9a6700;
}

@media (prefers-color-scheme: dark) {
    .edition-badge.stable {
        background-color: #238636;
        color: #dafbe1;
    }
    .edition-badge.insider {
        background-color: #1f6feb;
        color: #ddf4ff;
    }
    .edition-badge.cli {
        background-color: #9e6a03;
        color: #fff8c5;
    }
}

.session-id {
    margin-top: 10px;
    color: var(--text-secondary);
}

.session-id code {
    font-size: 0.85em;
    background-color: var(--code-bg);
    padding: 2px 6px;
    border-radius: 3px;
}

.source-file {
    margin-top: 5px;
    color: var(--text-secondary);
}

.source-file code {
    font-size: 0.8em;
    background-color: var(--code-bg);
    padding: 2px 6px;
    border-radius: 3px;
    word-break: break-all;
}

.message {
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.message.user {
    background-color: var(--user-bg);
}

.message.assistant {
    background-color: var(--assistant-bg);
}

.message-role {
    font-weight: 600;
    font-size: 0.85em;
    text-transform: uppercase;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.message-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.message-content pre {
    background-color: var(--code-bg);
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    border: 1px solid var(--border-color);
}

.message-content code {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    font-size: 0.9em;
    background-color: var(--code-bg);
    padding: 2px 6px;
    border-radius: 3px;
}

.message-content pre code {
    background-color: transparent;
    padding: 0;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.message-header .message-role {
    margin-bottom: 0;
}

.message-anchor {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.8em;
    opacity: 0.5;
    transition: opacity 0.2s;
    margin-left: auto;
}

.message-anchor:hover {
    opacity: 1;
    color: var(--link-color);
}

.message-timestamp {
    color: var(--text-secondary);
    font-size: 0.8em;
}

.message.highlighted {
    animation: highlight-pulse 2s ease-out;
}

@keyframes highlight-pulse {
    0% { box-shadow: 0 0 0 4px var(--link-color); }
    100% { box-shadow: none; }
}

/* Collapsible sections */
.collapsible {
    margin-top: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-tertiary);
}

.collapsible summary {
    padding: 10px 14px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
}

.collapsible summary:hover {
    background-color: var(--border-color);
}

.collapsible-icon {
    font-size: 0.7em;
    transition: transform 0.2s;
}

.collapsible-content {
    padding: 12px 14px;
    border-top: 1px solid var(--border-color);
}

/* Intent badge */
.intent-badge {
    display: inline-block;
    padding: 2px 10px;
    margin: 4px 0;
    border-radius: 10px;
    font-size: 0.8em;
    font-style: italic;
    background-color: #f3e8ff;
    color: #7c3aed;
}

@media (prefers-color-scheme: dark) {
    .intent-badge {
        background-color: rgba(139, 92, 246, 0.2);
        color: #c4b5fd;
    }
}

/* Skill badge */
.skill-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 10px;
    margin: 4px 0;
    border-radius: 10px;
    font-size: 0.8em;
    background-color: #e0e7ff;
    color: #4338ca;
}

.skill-badge code {
    font-size: 0.95em;
    background: transparent;
    padding: 0;
}

@media (prefers-color-scheme: dark) {
    .skill-badge {
        background-color: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
    }
}

/* Status badges for session events */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
    margin: 4px 0;
}

.status-badge.model-change {
    background-color: rgba(107, 114, 128, 0.15);
    color: #6b7280;
}

.status-badge.abort {
    background-color: rgba(239, 68, 68, 0.15);
    color: #dc2626;
}

.status-badge.error {
    background-color: rgba(239, 68, 68, 0.15);
    color: #dc2626;
}

@media (prefers-color-scheme: dark) {
    .status-badge.model-change {
        background-color: rgba(156, 163, 175, 0.2);
        color: #9ca3af;
    }
    .status-badge.abort,
    .status-badge.error {
        background-color: rgba(248, 113, 113, 0.2);
        color: #f87171;
    }
}

/* Thinking blocks */
.thinking-block {
    margin: 12px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-tertiary);
    border-left: 3px solid #9b59b6;
}

.thinking-block summary {
    padding: 10px 14px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9em;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
}

.thinking-block summary:hover {
    background-color: var(--border-color);
}

.thinking-icon {
    font-size: 1em;
    color: #9b59b6;
}

.thinking-label {
    font-weight: 600;
    color: #9b59b6;
}

@media (prefers-color-scheme: dark) {
    .thinking-icon, .thinking-label {
        color: #bb8fce;
    }
}

.thinking-description {
    color: var(--text-secondary);
    font-weight: 400;
    font-size: 0.9em;
    margin-left: 4px;
}

.thinking-content {
    padding: 12px 14px;
    border-top: 1px solid var(--border-color);
    font-size: 0.9em;
    color: var(--text-secondary);
    background-color: rgba(155, 89, 182, 0.05);
}

.thinking-content pre {
    background-color: var(--bg-tertiary);
}

/* Content blocks */
.content-block {
    margin: 4px 0;
}

.result-block {
    padding: 8px 12px;
    margin: 8px 0;
    border-left: 3px solid #2ea043;
    background-color: rgba(46, 160, 67, 0.05);
}

@media (prefers-color-scheme: dark) {
    .result-block {
        background-color: rgba(46, 160, 67, 0.1);
    }
}

/* Inline tool invocation blocks */
.tool-invocation-inline {
    margin: 8px 0;
}

.tool-invocation-inline .tool-invocation-message {
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 4px;
}

.tool-invocation-inline .tool-invocation-message p {
    margin: 0;
}

.tool-invocation-inline .tool-invocation-wrapper {
    margin-top: 4px;
    margin-left: 0;
}

/* Tool invocations */
.tool-summary {
    margin: 8px 0;
    color: var(--text-secondary);
    font-size: 0.9em;
}

/* Individual tool collapsible container */
.tool-invocation-wrapper {
    margin: 8px 0;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background-color: var(--bg-tertiary);
}

.tool-invocation-wrapper summary {
    padding: 10px 14px;
    cursor: pointer;
    font-size: 0.9em;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
    flex-wrap: wrap;
}

.tool-invocation-wrapper summary:hover {
    background-color: var(--border-color);
}

/* Tool invocation message in summary - render inline */
.tool-invocation-wrapper summary .tool-invocation-message {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.tool-invocation-wrapper summary .tool-invocation-message code {
    white-space: nowrap;
}

.tool-invocation-wrapper summary .tool-invocation-message p {
    margin: 0;
    display: inline;
}

.tool-invocation-wrapper .tool-name {
    font-weight: 600;
}

.tool-invocation-wrapper .collapsible-icon {
    font-size: 0.7em;
    transition: transform 0.2s;
}

.tool-invocation-content {
    padding: 12px 14px;
    border-top: 1px solid var(--border-color);
}

.tool-invocation {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.tool-invocation:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.tool-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.tool-section {
    margin-top: 8px;
}

.tool-label {
    display: block;
    font-size: 0.8em;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.tool-section pre {
    margin: 0;
    padding: 10px;
    font-size: 0.85em;
    max-height: 300px;
    overflow: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-word;
}

.tool-section code {
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-word;
}

/* Status badges */
.status-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: 500;
}

.status-badge.success, .status-badge.completed {
    background-color: #dafbe1;
    color: #1a7f37;
}

.status-badge.error, .status-badge.failed {
    background-color: #ffebe9;
    color: #cf222e;
}

.status-badge.pending, .status-badge.running {
    background-color: #fff8c5;
    color: #9a6700;
}

@media (prefers-color-scheme: dark) {
    .status-badge.success, .status-badge.completed {
        background-color: #238636;
        color: #dafbe1;
    }
    .status-badge.error, .status-badge.failed {
        background-color: #da3633;
        color: #ffebe9;
    }
    .status-badge.pending, .status-badge.running {
        background-color: #9e6a03;
        color: #fff8c5;
    }
}

/* File changes */
.file-change {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.file-change:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.file-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.language-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
}

.file-explanation {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin-bottom: 8px;
}

pre.diff {
    margin: 0;
    padding: 10px;
    font-size: 0.85em;
    max-height: 300px;
    overflow: auto;
}

/* Command runs */
.command-run {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.command-run:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.command-header {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 8px;
}

.command-text {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    background-color: var(--code-bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9em;
}

pre.command-output {
    margin: 0;
    padding: 10px;
    font-size: 0.85em;
    max-height: 200px;
    overflow: auto;
}

/* Terminal-style command display */
.terminal-command {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 12px;
    background-color: var(--bg-tertiary);
    overflow: hidden;
}

.terminal-command:last-child {
    margin-bottom: 0;
}

.terminal-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

.terminal-icon {
    font-size: 1.1em;
}

.terminal-icon.success, .terminal-icon.completed {
    color: #1a7f37;
}

.terminal-icon.error, .terminal-icon.failed {
    color: #cf222e;
}

.terminal-icon.pending, .terminal-icon.running {
    color: #9a6700;
}

@media (prefers-color-scheme: dark) {
    .terminal-icon.success, .terminal-icon.completed {
        color: #3fb950;
    }
    .terminal-icon.error, .terminal-icon.failed {
        color: #f85149;
    }
    .terminal-icon.pending, .terminal-icon.running {
        color: #d29922;
    }
}

.terminal-command-line {
    flex: 1;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    font-size: 0.9em;
    word-break: break-all;
}

.terminal-output-toggle {
    margin: 0;
}

.terminal-output-toggle summary {
    padding: 8px 14px;
    cursor: pointer;
    font-size: 0.85em;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
}

.terminal-output-toggle summary:hover {
    background-color: var(--border-color);
}

.terminal-output-content {
    padding: 12px 14px;
    border-top: 1px solid var(--border-color);
    background-color: var(--code-bg);
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    font-size: 0.85em;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow: auto;
}

/* File change statistics */
.file-stats {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace;
    font-size: 0.8em;
}

.file-stat-add {
    color: #1a7f37;
}

.file-stat-del {
    color: #cf222e;
}

@media (prefers-color-scheme: dark) {
    .file-stat-add {
        color: #3fb950;
    }
    .file-stat-del {
        color: #f85149;
    }
}

/* Collapsible code blocks */
.code-collapse-wrapper {
    position: relative;
}

.code-collapse-wrapper.collapsed pre {
    max-height: 400px;
    overflow: hidden;
}

.code-collapse-wrapper.collapsed::after {
    content: '';
    position: absolute;
    bottom: 32px;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(transparent, var(--code-bg));
    pointer-events: none;
}

.code-toggle-btn {
    display: block;
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 0 0 6px 6px;
    background-color: var(--bg-tertiary);
    color: var(--link-color);
    font-size: 0.85em;
    cursor: pointer;
    text-align: center;
    margin-top: -1px;
}

.code-toggle-btn:hover {
    background-color: var(--border-color);
}

/* Copy Markdown toolbar */
.copy-markdown-toolbar {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.copy-markdown-toolbar label {
    color: var(--text-secondary);
    font-size: 0.9em;
}

.copy-markdown-toolbar input[type="number"] {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    font-size: 0.9em;
    width: 60px;
}

.copy-markdown-toolbar input[type="number"]:focus {
    outline: 2px solid var(--link-color);
    outline-offset: -1px;
}

.range-separator {
    color: var(--text-secondary);
    font-size: 0.9em;
}

.toolbar-options {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-left: 8px;
    padding-left: 16px;
    border-left: 1px solid var(--border-color);
}

.toolbar-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-size: 0.85em;
}

.toolbar-options input[type="checkbox"] {
    accent-color: var(--link-color);
}

.copy-markdown-btn {
    background-color: var(--link-color);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.copy-markdown-btn:hover {
    opacity: 0.9;
}

.copy-markdown-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.copy-status {
    font-size: 0.85em;
    color: var(--text-secondary);
}

.copy-status.success {
    color: #1a7f37;
}

.copy-status.error {
    color: #cf222e;
}

/* Per-message copy button */
.message-copy-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 8px;
    font-size: 0.85em;
    opacity: 0.4;
    transition: opacity 0.2s, color 0.2s;
    margin-left: 8px;
}

.message-copy-btn:hover {
    opacity: 1;
    color: var(--link-color);
}

.message-copy-btn.copied {
    color: #1a7f37;
    opacity: 1;
}

/* Tables */
.message-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    font-size: 0.9em;
}

.message-content table th,
.message-content table td {
    border: 1px solid #d0d7de;
    padding: 8px 12px;
    text-align: left;
}

.message-content table th {
    background-color: var(--bg-secondary);
    font-weight: 600;
}

@media (prefers-color-scheme: dark) {
    .message-content table th,
    .message-content table td {
        border-color: #30363d;
    }
}

footer {
    margin-top: 40px;
    padding: 20px 0;
    border-top: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: 0.85em;
    text-align: center;
}

footer a {
    color: var(--link-color);
    text-decoration: none;
}
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>{{ title }}</h1>
        </div>
    </header>

    <main class="container">
        <a href="/" class="back-link">&larr; Back to all sessions</a>

        <div class="session-header">
            <h2 id="session-title">
                {% if session.custom_title %}
                    {{ session.custom_title }}
                {% elif session.workspace_name %}
                    {{ session.workspace_name }}
                {% elif first_user_prompt %}
                    <em>{{ first_user_prompt | truncate(100, True) }}</em>
                {% else %}
                    Session {{ session.session_id[:8] }}...
                {% endif %}
            </h2>
            <div class="session-meta">
                <span>{{ message_count }} messages</span>
                {% if session.workspace_path %}
                <span>Path: {{ session.workspace_path | urldecode }}</span>
                {% endif %}
                {% if session.created_at %}
                <span>Created: {{ session.created_at | format_timestamp }}</span>
                {% endif %}
                <span class="edition-badge {{ session.vscode_edition }}">{{ session.vscode_edition }}</span>
            </div>
            <div class="session-id">
                <small>Session ID: <code>{{ session.session_id }}</code></small>
            </div>
            {% if session.source_file %}
            <div class="source-file">
                <small>Source: <code>{{ session.source_file }}</code></small>
            </div>
            {% endif %}
        </div>

        <!-- Copy Markdown Toolbar -->
        <div class="copy-markdown-toolbar">
            <label>Messages:</label>
            <input type="number" id="range-start" min="1" max="{{ message_count }}" placeholder="1" title="Start message (leave empty for first)">
            <span class="range-separator">to</span>
            <input type="number" id="range-end" min="1" max="{{ message_count }}" placeholder="{{ message_count }}" title="End message (leave empty for last)">
            
            <div class="toolbar-options">
                <label title="Include file change diffs in the markdown">
                    <input type="checkbox" id="include-diffs" checked>
                    Diffs
                </label>
                <label title="Include tool inputs in the markdown">
                    <input type="checkbox" id="include-tool-inputs" checked>
                    Tool inputs
                </label>
                <label title="Include thinking/reasoning blocks in the markdown">
                    <input type="checkbox" id="include-thinking">
                    Thinking
                </label>
            </div>
            
            <button type="button" class="copy-markdown-btn" id="copy-markdown-btn" data-session-id="{{ session.session_id }}" data-message-count="{{ message_count }}">
                <i class="fa-regular fa-copy"></i> Copy Markdown
            </button>
            <button type="button" class="copy-markdown-btn" id="download-markdown-btn" data-session-id="{{ session.session_id }}" data-message-count="{{ message_count }}">
                <i class="fa-solid fa-download"></i> Download
            </button>
            <button type="button" class="copy-markdown-btn" id="copy-url-btn" data-session-id="{{ session.session_id }}" data-message-count="{{ message_count }}">
                <i class="fa-solid fa-link"></i> Copy URL
            </button>
            <span class="copy-status" id="copy-status"></span>
        </div>

        <div class="messages">
            {% for message in session.messages %}
            <div class="message {{ message.role }}" id="msg-{{ loop.index }}">
                <div class="message-header">
                    <div class="message-role">{{ message.role }}</div>
                    {% if message.timestamp %}
                    <span class="message-timestamp">{{ message.timestamp | format_timestamp }}</span>
                    {% endif %}
                    <a href="#msg-{{ loop.index }}" class="message-anchor" title="Link to this message">#{{ loop.index }}</a>
                    <button type="button" class="message-copy-btn" data-message-index="{{ loop.index }}" data-session-id="{{ session.session_id }}" title="Copy this message as markdown">
                        <i class="fa-regular fa-copy"></i>
                    </button>
                </div>
                <div class="message-content">
                    {% if message.content_blocks %}
                        {# Render structured content blocks with kind differentiation #}
                        {% for block in message.content_blocks %}
                            {% if block.kind == 'intent' %}
                            <span class="intent-badge">{{ block.content }}</span>
                            {% elif block.kind == 'skill' %}
                            <span class="skill-badge">skill: <code>{{ block.content }}</code></span>
                            {% elif block.kind == 'status' %}
                            <span class="status-badge {{ block.description or '' }}">{{ block.content }}</span>
                            {% elif block.kind == 'thinking' %}
                            <details class="thinking-block">
                                <summary>
                                    <span class="collapsible-icon" aria-hidden="true">▶</span>
                                    <span class="thinking-label">Thinking</span>
                                    {% if block.description %}
                                    <span class="thinking-description">— {{ block.description }}</span>
                                    {% endif %}
                                </summary>
                                <div class="thinking-content">
                                    {{ block.content | markdown | safe }}
                                </div>
                            </details>
                            {% elif block.kind == 'toolInvocation' %}
                            {# Check for matched command run first (for CLI shell commands) #}
                            {% set matched_cmd = message._block_cmd_map.get(loop.index0) if message._block_cmd_map else None %}
                            
                            {# Then check for matched tool invocation #}
                            {% set matched_tool = message._block_tool_map.get(loop.index0) if message._block_tool_map else None %}
                            
                            {% if matched_cmd %}
                            {# CLI command run - show as collapsible command block with Input/Output like VSCode logs #}
                            <div class="content-block content-block-toolInvocation tool-invocation-inline">
                                <details class="tool-invocation-wrapper">
                                    <summary>
                                        <span class="collapsible-icon" aria-hidden="true">▶</span>
                                        <span class="tool-invocation-message"><code>{{ matched_cmd.command | truncate(80, True) }}</code></span>
                                        {% if matched_cmd.status %}
                                        <span class="status-badge {{ matched_cmd.status }}">{{ matched_cmd.status }}</span>
                                        {% endif %}
                                    </summary>
                                    <div class="tool-invocation-content">
                                        <div class="tool-section">
                                            <span class="tool-label">Input:</span>
                                            <pre><code>{{ matched_cmd.command }}</code></pre>
                                        </div>
                                        {% if matched_cmd.output or matched_cmd.result %}
                                        <div class="tool-section">
                                            <span class="tool-label">Output:</span>
                                            <pre><code>{{ (matched_cmd.output or matched_cmd.result) | strip_ansi }}</code></pre>
                                        </div>
                                        {% endif %}
                                    </div>
                                </details>
                            </div>
                            {% elif matched_tool %}
                            {# Show collapsible details for tools with input/output: #}
                            {# - MCP tools (source_type == 'mcp') #}
                            {# - run_in_terminal (has command input and terminal output) #}
                            {# Internal file tools (copilot_readFile, etc.) just show pretty invocation message #}
                            {% set is_mcp_tool = matched_tool.source_type == 'mcp' %}
                            {% set is_terminal_tool = matched_tool.name == 'run_in_terminal' %}
                            {% set has_tool_details = matched_tool.input or matched_tool.result %}
                            {% set show_collapsible = (is_mcp_tool or is_terminal_tool) and has_tool_details %}
                            
                            {# Determine the pretty header text - use invocation_message if available, else block content #}
                            {% set pretty_header = matched_tool.invocation_message if matched_tool.invocation_message else block.content %}
                            
                            {% if show_collapsible %}
                            <div class="content-block content-block-toolInvocation tool-invocation-inline">
                                <details class="tool-invocation-wrapper">
                                    <summary>
                                        <span class="collapsible-icon" aria-hidden="true">▶</span>
                                        <span class="tool-invocation-message">{{ pretty_header | markdown | safe }}</span>
                                        {% if matched_tool.status %}
                                        <span class="status-badge {{ matched_tool.status }}">{{ matched_tool.status }}</span>
                                        {% endif %}
                                    </summary>
                                    <div class="tool-invocation-content">
                                        <div class="tool-section">
                                            <span class="tool-label">Tool:</span>
                                            <code>{{ matched_tool.name }}</code>
                                        </div>
                                        {% if matched_tool.input %}
                                        <div class="tool-section">
                                            <span class="tool-label">Input:</span>
                                            <pre><code>{{ matched_tool.input }}</code></pre>
                                        </div>
                                        {% endif %}
                                        {% if matched_tool.result %}
                                        <div class="tool-section">
                                            <span class="tool-label">Output:</span>
                                            <pre><code>{{ matched_tool.result | strip_ansi }}</code></pre>
                                        </div>
                                        {% endif %}
                                    </div>
                                </details>
                            </div>
                            {% else %}
                            {# Tool without collapsible details - just show the pretty message #}
                            <div class="content-block content-block-toolInvocation">
                                {{ pretty_header | markdown | safe }}
                            </div>
                            {% endif %}
                            {% else %}
                            {# Unmatched tool invocation - just show the content #}
                            <div class="content-block content-block-toolInvocation">
                                {{ block.content | markdown | safe }}
                            </div>
                            {% endif %}
                            {% elif block.kind == 'text' %}
                            <div class="content-block content-block-text result-block">
                                {{ block.content | markdown | safe }}
                            </div>
                            {% else %}
                            <div class="content-block content-block-{{ block.kind }}">
                                {{ block.content | markdown | safe }}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {# Fallback to flat content for backwards compatibility #}
                        {{ message.content | markdown | safe }}
                    {% endif %}
                </div>

                {# Only show unmatched tool invocations at the bottom #}
                {# Include MCP tools and run_in_terminal with input/output #}
                {% set unmatched_tools = [] %}
                {% for tool in message.tool_invocations %}
                    {% set is_collapsible_tool = (tool.source_type == 'mcp' or tool.name == 'run_in_terminal') and (tool.input or tool.result) %}
                    {% if tool.name not in message._matched_tool_names and is_collapsible_tool %}
                        {% set _ = unmatched_tools.append(tool) %}
                    {% endif %}
                {% endfor %}
                
                {% if unmatched_tools %}
                <p class="tool-summary"><em>Used {{ unmatched_tools | length }} tool{{ 's' if unmatched_tools | length > 1 else '' }}: {{ unmatched_tools | map(attribute='name') | list | join(', ') | truncate(100) }}</em></p>
                <details class="collapsible tool-invocations-header" open>
                    <summary aria-label="Toggle tool invocations section">
                        <span class="collapsible-icon" aria-hidden="true">▼</span>
                        Tool Invocations ({{ unmatched_tools | length }})
                    </summary>
                    <div class="collapsible-content">
                        {% for tool in unmatched_tools %}
                        <details class="tool-invocation-wrapper">
                            <summary>
                                <span class="collapsible-icon" aria-hidden="true">▶</span>
                                {% if tool.invocation_message %}
                                <span class="tool-invocation-message">{{ tool.invocation_message | markdown | safe }}</span>
                                {% else %}
                                <span class="tool-name">{{ tool.name }}</span>
                                {% endif %}
                                {% if tool.status %}
                                <span class="status-badge {{ tool.status }}">{{ tool.status }}</span>
                                {% endif %}
                            </summary>
                            <div class="tool-invocation-content">
                                <div class="tool-section">
                                    <span class="tool-label">Tool:</span>
                                    <code>{{ tool.name }}</code>
                                </div>
                                {% if tool.input %}
                                <div class="tool-section">
                                    <span class="tool-label">Input:</span>
                                    <pre><code>{{ tool.input }}</code></pre>
                                </div>
                                {% endif %}
                                {% if tool.result %}
                                <div class="tool-section">
                                    <span class="tool-label">Output:</span>
                                    <pre><code>{{ tool.result | strip_ansi }}</code></pre>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}

                {% if message.file_changes %}
                <p class="tool-summary"><em>Changed {{ message.file_changes | length }} file{{ 's' if message.file_changes | length > 1 else '' }}: {{ message.file_changes | map(attribute='path') | list | join(', ') | truncate(100) }}</em></p>
                <details class="collapsible file-changes">
                    <summary aria-label="Toggle file changes section">
                        <span class="collapsible-icon" aria-hidden="true">▶</span>
                        File Changes ({{ message.file_changes | length }})
                    </summary>
                    <div class="collapsible-content">
                        {% for change in message.file_changes %}
                        <div class="file-change">
                            <div class="file-header">
                                <strong>{{ change.path | extract_filename }}</strong>
                                {% if change.language_id %}
                                <span class="language-badge">{{ change.language_id }}</span>
                                {% endif %}
                                {% if change.diff %}
                                {% set stats = change.diff | parse_diff_stats %}
                                <span class="file-stats">
                                    {% if stats.additions > 0 %}<span class="file-stat-add">+{{ stats.additions }}</span>{% endif %}
                                    {% if stats.deletions > 0 %}<span class="file-stat-del">-{{ stats.deletions }}</span>{% endif %}
                                </span>
                                {% endif %}
                            </div>
                            {% if change.explanation %}
                            <div class="file-explanation">{{ change.explanation }}</div>
                            {% endif %}
                            {% if change.diff %}
                            <pre class="diff"><code>{{ change.diff }}</code></pre>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}

                {# Only show Command Runs section for commands not already rendered inline #}
                {% set unmatched_cmd_count = (message.command_runs | length) - (message._matched_cmd_indices | length if message._matched_cmd_indices else 0) %}
                {% if message.command_runs and unmatched_cmd_count > 0 %}
                <p class="tool-summary"><em>Ran {{ unmatched_cmd_count }} command{{ 's' if unmatched_cmd_count > 1 else '' }}</em></p>
                <details class="collapsible command-runs" open>
                    <summary aria-label="Toggle command runs section">
                        <span class="collapsible-icon" aria-hidden="true">▼</span>
                        Command Runs ({{ unmatched_cmd_count }})
                    </summary>
                    <div class="collapsible-content">
                        {% for cmd in message.command_runs %}
                        {# Skip commands already rendered inline #}
                        {% if loop.index0 not in (message._matched_cmd_indices or []) %}
                        <div class="terminal-command">
                            <div class="terminal-header">
                                <span class="terminal-icon {{ cmd.status or 'pending' }}" aria-hidden="true">
                                    {%- if cmd.status == 'success' or cmd.status == 'completed' -%}
                                        ✓
                                    {%- elif cmd.status == 'error' or cmd.status == 'failed' -%}
                                        ✗
                                    {%- else -%}
                                        ●
                                    {%- endif -%}
                                </span>
                                <span class="terminal-command-line">{{ cmd.command }}</span>
                                {% if cmd.status %}
                                <span class="status-badge {{ cmd.status }}">{{ cmd.status }}</span>
                                {% endif %}
                            </div>
                            {% if cmd.output %}
                            <details class="terminal-output-toggle">
                                <summary>
                                    <span class="collapsible-icon" aria-hidden="true">▶</span>
                                    Show output
                                </summary>
                                <div class="terminal-output-content">{{ cmd.output | strip_ansi }}</div>
                            </details>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </main>

    <footer>
        <div class="container">
            Powered by <a href="https://github.com/Arithmomaniac/copilot-repository-tools">Copilot Chat Archive</a>
        </div>
    </footer>

    <script>
        // Handle anchor scrolling with smooth scroll
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash) {
                const target = document.querySelector(window.location.hash);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    target.classList.add('highlighted');
                }
            }

            // Toggle collapsible icon on details open/close
            document.querySelectorAll('details.collapsible, details.tool-invocations-header, details.terminal-output-toggle, details.tool-invocation-wrapper').forEach(details => {
                details.addEventListener('toggle', function() {
                    const icon = this.querySelector(':scope > summary > .collapsible-icon');
                    if (icon) {
                        icon.textContent = this.open ? '▼' : '▶';
                    }
                });
            });

            // Auto-collapse long code blocks (more than 20 lines)
            const CODE_LINE_THRESHOLD = 20;
            document.querySelectorAll('.message-content pre').forEach(function(pre) {
                const code = pre.querySelector('code') || pre;
                const text = code.textContent || '';
                // Count lines properly: empty string = 0 lines, otherwise count newlines + 1
                const lineCount = text.length === 0 ? 0 : (text.match(/\n/g) || []).length + 1;

                if (lineCount > CODE_LINE_THRESHOLD) {
                    // Wrap the pre in a collapse wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-collapse-wrapper collapsed';
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(pre);

                    // Add toggle button
                    const btn = document.createElement('button');
                    btn.className = 'code-toggle-btn';
                    btn.textContent = 'Show more (' + lineCount + ' lines)';
                    btn.setAttribute('type', 'button');
                    wrapper.appendChild(btn);

                    btn.addEventListener('click', function() {
                        const isCollapsed = wrapper.classList.toggle('collapsed');
                        btn.textContent = isCollapsed 
                            ? 'Show more (' + lineCount + ' lines)' 
                            : 'Show less';
                    });
                }
            });

            // Shared helper to build query params from toolbar state
            function buildMarkdownParams() {
                const messageCount = parseInt(document.getElementById('copy-markdown-btn').dataset.messageCount, 10);
                const rangeStart = document.getElementById('range-start');
                const rangeEnd = document.getElementById('range-end');
                const includeDiffs = document.getElementById('include-diffs');
                const includeToolInputs = document.getElementById('include-tool-inputs');
                const includeThinking = document.getElementById('include-thinking');

                const start = rangeStart.value ? parseInt(rangeStart.value, 10) : 1;
                const end = rangeEnd.value ? parseInt(rangeEnd.value, 10) : messageCount;

                // Validate range
                if (start < 1 || start > messageCount || end < 1 || end > messageCount || start > end) {
                    return null; // invalid range
                }

                const params = new URLSearchParams();
                if (start !== 1 || end !== messageCount) {
                    params.set('start', start);
                    params.set('end', end);
                }
                params.set('include_diffs', includeDiffs.checked);
                params.set('include_tool_inputs', includeToolInputs.checked);
                params.set('include_thinking', includeThinking.checked);

                return params;
            }

            const copyStatus = document.getElementById('copy-status');

            function showStatus(text, type) {
                copyStatus.textContent = text;
                copyStatus.className = 'copy-status' + (type ? ' ' + type : '');
                if (type === 'success') {
                    setTimeout(() => { copyStatus.textContent = ''; }, 3000);
                }
            }

            // Copy Markdown button
            const copyBtn = document.getElementById('copy-markdown-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', async function() {
                    const params = buildMarkdownParams();
                    if (!params) {
                        showStatus('✗ Invalid range', 'error');
                        return;
                    }
                    const sessionId = this.dataset.sessionId;
                    const queryString = params.toString() ? '?' + params.toString() : '';

                    copyBtn.disabled = true;
                    showStatus('Fetching...', '');

                    try {
                        const response = await fetch('/api/markdown/' + sessionId + queryString);
                        const data = await response.json();
                        if (response.ok && data.markdown) {
                            await navigator.clipboard.writeText(data.markdown);
                            showStatus('✓ Copied to clipboard!', 'success');
                        } else {
                            showStatus('✗ ' + (data.error || 'Failed to get markdown'), 'error');
                        }
                    } catch (err) {
                        showStatus('✗ Error: ' + err.message, 'error');
                    } finally {
                        copyBtn.disabled = false;
                    }
                });
            }

            // Download Markdown button
            const downloadBtn = document.getElementById('download-markdown-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    const params = buildMarkdownParams();
                    if (!params) {
                        showStatus('✗ Invalid range', 'error');
                        return;
                    }
                    const sessionId = this.dataset.sessionId;
                    const queryString = params.toString() ? '?' + params.toString() : '';
                    const sep = queryString ? '&' : '?';
                    window.location.href = '/api/markdown/' + sessionId + queryString + sep + 'download=true';
                });
            }

            // Copy URL button
            const copyUrlBtn = document.getElementById('copy-url-btn');
            if (copyUrlBtn) {
                copyUrlBtn.addEventListener('click', async function() {
                    const params = buildMarkdownParams();
                    if (!params) {
                        showStatus('✗ Invalid range', 'error');
                        return;
                    }
                    const sessionId = this.dataset.sessionId;
                    const queryString = params.toString() ? '?' + params.toString() : '';
                    const url = window.location.origin + '/api/markdown/' + sessionId + queryString;

                    try {
                        await navigator.clipboard.writeText(url);
                        showStatus('✓ URL copied!', 'success');
                    } catch (err) {
                        showStatus('✗ Error: ' + err.message, 'error');
                    }
                });
            }

            // Per-message copy buttons
            document.querySelectorAll('.message-copy-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const sessionId = this.dataset.sessionId;
                    const messageIndex = this.dataset.messageIndex;
                    const icon = this.querySelector('i');
                    
                    try {
                        const response = await fetch('/api/markdown/' + sessionId + '?start=' + messageIndex + '&end=' + messageIndex);
                        const data = await response.json();
                        
                        if (response.ok && data.markdown) {
                            await navigator.clipboard.writeText(data.markdown);
                            
                            // Show success feedback
                            this.classList.add('copied');
                            icon.classList.remove('fa-copy');
                            icon.classList.add('fa-check');
                            
                            // Reset after 2 seconds
                            setTimeout(() => {
                                this.classList.remove('copied');
                                icon.classList.remove('fa-check');
                                icon.classList.add('fa-copy');
                            }, 2000);
                        }
                    } catch (err) {
                        console.error('Failed to copy message:', err);
                    }
                });
            });
        });
    </script>
</body>
</html>
